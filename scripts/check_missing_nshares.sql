select * from (select * from (select symbol_id, avg(n_shares_xbrl), extract(year from period_end) from analysis_financialcontext group by extract(year from period_end), symbol_id order by symbol_id, date_part) x join analysis_symbol sy on x.symbol_id = sy.id where date_part < 2017 and avg is null order by symbol_id, date_part) xbrl right join analysis_symbolnshares ns on extract(year from date) = xbrl.date_part and ns.symbol_id = xbrl.symbol_id;
